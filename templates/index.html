<html>
    <head>
        <title>Local Net Monit</title>

        <style>
            /* charcoal dark background */
            * {
                box-sizing: border-box;
            }

            body {
                background-color: #2b2b2b;
                color: #e0e0e0;
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    "Helvetica Neue", Arial, sans-serif;
                margin: 0;
                padding: 0;
                min-height: 100vh;
                display: flex;
                flex-direction: column;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                width: 100%;
                padding: 0 20px;
            }

            /* Header section */
            .header {
                background-color: #1e1e1e;
                padding: 20px 0;
                border-bottom: 2px solid #404040;
            }

            .header-content {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                flex-wrap: wrap;
                gap: 20px;
            }

            .title-section {
                flex: 1;
                min-width: 250px;
            }

            .title-top {
                font-size: 28px;
                font-weight: 600;
                margin-bottom: 10px;
                color: #ffffff;
            }

            /* Scan timestamps in header */
            .scans-info {
                flex: 1;
                min-width: 300px;
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                font-size: 13px;
            }

            .scan-timestamp {
                background-color: #2b2b2b;
                padding: 10px 15px;
                border-radius: 6px;
                border-left: 3px solid #5cb85c;
            }

            .scan-label {
                font-weight: 600;
                color: #a0a0a0;
                display: block;
                margin-bottom: 4px;
                font-size: 11px;
                text-transform: uppercase;
            }

            /* Internet section */
            .internet-section {
                background: linear-gradient(135deg, #1e1e1e 0%, #2b2b2b 100%);
                padding: 30px 0;
                border-bottom: 3px solid #404040;
            }

            .section-title {
                text-align: center;
                font-size: 20px;
                font-weight: 600;
                margin-bottom: 25px;
                color: #ffffff;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            /* Local network section */
            .local-section {
                flex: 1;
                padding: 30px 0;
            }

            .port-boxes {
                display: flex;
                justify-content: center;
                gap: 15px;
                flex-wrap: wrap;
                padding: 0 20px;
            }

            /* Improved port box styling */
            .port-box {
                min-width: 80px;
                padding: 12px 16px;
                background-color: #333;
                border: 2px solid #5cb85c;
                border-radius: 8px;
                position: relative;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                color: #ffffff;
                font-size: 14px;
                font-weight: 600;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            }

            .port-box:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
                border-color: #6cd76c;
            }

            .port-box-warning {
                border-color: #d9534f;
                background-color: #3a2a2a;
            }

            .port-box-warning:hover {
                border-color: #e57373;
            }

            /* Status indicator badge */
            .port-box::before {
                content: "";
                position: absolute;
                top: -6px;
                right: -6px;
                width: 16px;
                height: 16px;
                background-color: #5cb85c;
                border: 2px solid #2b2b2b;
                border-radius: 50%;
                box-shadow: 0 0 6px rgba(92, 184, 92, 0.6);
            }

            .port-box-warning::before {
                background-color: #d9534f;
                box-shadow: 0 0 6px rgba(217, 83, 79, 0.6);
            }

            /* Port number label */
            .port-number {
                font-size: 18px;
                margin-bottom: 4px;
            }

            .port-label {
                font-size: 11px;
                color: #a0a0a0;
                font-weight: normal;
            }

            .port-has-notes {
                color: #ffc107;
                margin-left: 4px;
            }

            /* Styling for the IP table */
            .ip-table-container {
                width: 100%;
                overflow-x: auto;
            }

            .ip-table {
                width: 100%;
                border-collapse: collapse;
                background-color: #333;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            }

            .ip-table th {
                padding: 16px 12px;
                background-color: #1e1e1e;
                color: #ffffff;
                font-weight: 600;
                text-align: left;
                text-transform: uppercase;
                font-size: 12px;
                letter-spacing: 0.5px;
                border-bottom: 2px solid #404040;
            }

            .ip-table td {
                padding: 14px 12px;
                background-color: #2b2b2b;
                color: #e0e0e0;
                border-bottom: 1px solid #404040;
                vertical-align: middle;
            }

            .ip-table tbody tr {
                transition: background-color 0.2s ease;
            }

            .ip-table tbody tr:hover {
                background-color: #333;
            }

            .ip-table tbody tr:last-child td {
                border-bottom: none;
            }

            /* Status column */
            .status-cell {
                text-align: center;
                width: 60px;
            }

            /* IP column */
            .ip-cell {
                min-width: 140px;
            }

            /* Name column */
            .name-cell {
                min-width: 120px;
            }

            /* Last seen column */
            .last-seen-cell {
                min-width: 140px;
                font-size: 13px;
                color: #a0a0a0;
            }

            /* Latency column */
            .latency-cell {
                text-align: center;
                min-width: 100px;
                font-family: "Monaco", "Courier New", monospace;
                font-size: 13px;
            }

            /* Ports column */
            .ports-column {
                min-width: 200px;
            }

            .port-container {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                max-width: 100%;
            }

            .port-container .port-box {
                min-width: 60px;
                padding: 8px 12px;
                font-size: 13px;
            }

            .port-container .port-number {
                font-size: 15px;
            }

            /* Clickable IP styling */
            .clickable-ip {
                cursor: pointer;
                color: #6eb4ff;
                text-decoration: none;
                font-weight: 600;
                transition: color 0.2s ease;
                font-family: "Monaco", "Courier New", monospace;
            }

            .clickable-ip:hover {
                color: #8fc9ff;
                text-decoration: underline;
            }

            /* Popup modal */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.75);
                backdrop-filter: blur(4px);
                animation: fadeIn 0.2s ease;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            .modal-content {
                background-color: #2b2b2b;
                margin: 5% auto;
                padding: 30px;
                border: 2px solid #404040;
                width: 90%;
                max-width: 500px;
                color: #e0e0e0;
                text-align: center;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
                animation: slideDown 0.3s ease;
                max-height: 90vh;
                overflow-y: auto;
            }

            @keyframes slideDown {
                from {
                    transform: translateY(-50px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            .modal-content h2 {
                margin-top: 0;
                color: #ffffff;
                font-size: 22px;
            }

            .close {
                color: #888;
                float: right;
                font-size: 32px;
                font-weight: bold;
                line-height: 20px;
                transition: color 0.2s ease;
                margin: -10px -10px 0 0;
            }

            .close:hover,
            .close:focus {
                color: #ffffff;
                text-decoration: none;
                cursor: pointer;
            }

            /* Styling for form elements */
            form {
                display: flex;
                flex-direction: column;
                gap: 20px;
                margin-top: 25px;
            }

            label {
                font-size: 14px;
                font-weight: 600;
                color: #a0a0a0;
                margin-bottom: 6px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .modal-checkbox-container {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px;
                background-color: #333;
                border-radius: 6px;
            }

            .modal-port-notes-container,
            .modal-ip-name-container {
                text-align: left;
                width: 100%;
            }

            input[type="checkbox"] {
                width: 24px;
                height: 24px;
                cursor: pointer;
                accent-color: #5cb85c;
            }

            textarea,
            input[type="text"] {
                width: 100%;
                padding: 12px 16px;
                font-size: 15px;
                border-radius: 6px;
                border: 2px solid #404040;
                background-color: #1e1e1e;
                color: #e0e0e0;
                resize: vertical;
                transition: border-color 0.2s ease;
                font-family: inherit;
            }

            textarea:focus,
            input[type="text"]:focus {
                outline: none;
                border-color: #5cb85c;
            }

            textarea {
                min-height: 100px;
            }

            button {
                padding: 14px 28px;
                font-size: 16px;
                font-weight: 600;
                border: none;
                border-radius: 8px;
                background-color: #5cb85c;
                color: #ffffff;
                cursor: pointer;
                transition: all 0.2s ease;
                margin-top: 10px;
            }

            button:hover {
                background-color: #6cd76c;
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(92, 184, 92, 0.3);
            }

            button:active {
                transform: translateY(0);
            }

            .recent-changes {
                background-color: #1e1e1e;
                padding: 20px;
                border-radius: 8px;
                border-left: 4px solid #5cb85c;
                margin-bottom: 20px;
            }

            .recent-changes h3 {
                margin: 0 0 15px 0;
                font-size: 16px;
                color: #ffffff;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .recent-changes ul {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .recent-changes li {
                padding: 8px 0;
                font-size: 14px;
                color: #a0a0a0;
                border-bottom: 1px solid #333;
            }

            .recent-changes li:last-child {
                border-bottom: none;
            }

            /* Status indicators */
            .status-dot {
                height: 14px;
                width: 14px;
                border-radius: 50%;
                display: inline-block;
                position: relative;
                border: 2px solid transparent;
            }

            .status-dot-up {
                background-color: #5cb85c;
                box-shadow: 0 0 8px rgba(92, 184, 92, 0.5);
            }

            .status-dot-down {
                background-color: #d9534f;
                box-shadow: 0 0 8px rgba(217, 83, 79, 0.5);
            }

            /* Latency display with visual indicator */
            .latency-display {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .latency-bar {
                width: 50px;
                height: 6px;
                background-color: #1e1e1e;
                border-radius: 3px;
                overflow: hidden;
                position: relative;
            }

            .latency-bar-fill {
                height: 100%;
                border-radius: 3px;
                transition: width 0.3s ease;
            }

            .latency-excellent {
                background-color: #5cb85c;
            }
            .latency-good {
                background-color: #5bc0de;
            }
            .latency-fair {
                background-color: #f0ad4e;
            }
            .latency-poor {
                background-color: #d9534f;
            }

            /* Status legend */
            .status-legend {
                display: flex;
                gap: 20px;
                justify-content: center;
                align-items: center;
                padding: 15px;
                background-color: #1e1e1e;
                border-radius: 8px;
                margin-bottom: 20px;
                flex-wrap: wrap;
                font-size: 13px;
            }

            .legend-item {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .legend-title {
                font-weight: 600;
                color: #ffffff;
                font-size: 14px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-right: 10px;
            }

            .legend-label {
                color: #a0a0a0;
            }

            /* Verify all button styling */
            .verify-all-container {
                margin-top: 10px;
                text-align: center;
            }

            .verify-all-container button {
                font-size: 13px;
                padding: 8px 16px;
                background-color: #f0ad4e;
            }

            .verify-all-container button:hover {
                background-color: #f5c277;
            }
        </style>
    </head>
    <body>
        <!-- Header -->
        <div class="header">
            <div class="container">
                <div class="header-content">
                    <div class="title-section">
                        <div class="title-top">
                            Internet ({{ .NetScanner.PublicNode.IP }})
                        </div>
                    </div>
                    <div class="scans-info">
                        {{if .MonitorPublicPorts}}
                        <div class="scan-timestamp">
                            <span class="scan-label">Public Full Scan</span>
                            <span
                                class="human-time"
                                data-time="{{ .LastPublicFullScanLoop }}"
                            ></span>
                        </div>
                        <div class="scan-timestamp">
                            <span class="scan-label">Public Partial Scan</span>
                            <span
                                class="human-time"
                                data-time="{{ .LastPublicScanLoop }}"
                            ></span>
                        </div>
                        {{end}}
                        <div class="scan-timestamp">
                            <span class="scan-label">Local Full Scan</span>
                            <span
                                class="human-time"
                                data-time="{{ .LastLocalFullScanLoop }}"
                            ></span>
                        </div>
                        <div class="scan-timestamp">
                            <span class="scan-label">Local Partial Scan</span>
                            <span
                                class="human-time"
                                data-time="{{ .LastLocalScanLoop }}"
                            ></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Internet Section -->
        {{if .MonitorPublicPorts}}
        <div class="internet-section">
            <div class="container">
                <div class="section-title">Internet Ports</div>
                <div class="port-boxes">
                    {{range $port := .NetScanner.PublicNode.Ports }}
                    <div
                        title="{{$port.Notes}}"
                        class="port-box {{if not $port.Verified}}port-box-warning{{end}}"
                        onclick="openPortModal({ ip: '{{ $.NetScanner.PublicNode.IP }}', portNumber: {{ $port.PortNumber }}, verified: {{ $port.Verified }}, notes: '{{ $port.Notes }}', lastSeenAt: '{{ $port.LastSeenAt }}'})"
                    >
                        <div class="port-number">{{ $port.PortNumber }}</div>
                        <div class="port-label">
                            {{if $port.Notes}}<span class="port-has-notes"
                                >★</span
                            >{{end}}
                        </div>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>
        {{end}}

        <!-- Local Network Section -->
        <div class="local-section">
            <div class="container">
                <div class="section-title">Local Network</div>

                <!-- Recent Changes -->
                {{if .RecentChanges}}
                <div class="recent-changes">
                    <h3>Recent Changes</h3>
                    <ul>
                        {{range $change := .RecentChanges}}
                        <li>
                            <span
                                class="human-time"
                                data-time="{{$change.Timestamp}}"
                            ></span>
                            - {{$change.Description}}
                        </li>
                        {{end}}
                    </ul>
                </div>
                {{end}}

                <!-- Status Legend -->
                <div class="status-legend">
                    <div class="legend-title">Legend:</div>
                    <div class="legend-item">
                        <span class="status-dot status-dot-up"></span>
                        <span class="legend-label">Online & Verified</span>
                    </div>
                    <div class="legend-item">
                        <span class="status-dot status-dot-down"></span>
                        <span class="legend-label">Offline / Unverified</span>
                    </div>
                    <div class="legend-item">
                        <div
                            class="port-box"
                            style="
                                min-width: 60px;
                                padding: 6px 10px;
                                pointer-events: none;
                            "
                        >
                            <div class="port-number" style="font-size: 14px">
                                -
                            </div>
                        </div>
                        <span class="legend-label">Verified Port</span>
                    </div>
                    <div class="legend-item">
                        <div
                            class="port-box port-box-warning"
                            style="
                                min-width: 60px;
                                padding: 6px 10px;
                                pointer-events: none;
                            "
                        >
                            <div class="port-number" style="font-size: 14px">
                                -
                            </div>
                        </div>
                        <span class="legend-label">Unverified Port</span>
                    </div>
                </div>

                <!-- IP table -->
                <div class="ip-table-container">
                    <table class="ip-table">
                        <thead>
                            <tr>
                                <th class="status-cell">Status</th>
                                <th class="ip-cell">IP Address</th>
                                <th class="name-cell">Name</th>
                                <th class="last-seen-cell">Last Seen</th>
                                <th class="latency-cell">Latency</th>
                                <th class="ports-column">Ports</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range $ip, $node := .NodeStatuses }}
                            <tr>
                                <td class="status-cell">
                                    {{ if $node.Verified }}
                                    <span
                                        class="status-dot status-dot-up"
                                        title="Online & Verified"
                                    ></span>
                                    {{else}}
                                    <span
                                        class="status-dot status-dot-down"
                                        title="Offline / Unverified"
                                    ></span>
                                    {{end}}
                                </td>
                                <td class="ip-cell">
                                    <span
                                        class="clickable-ip"
                                        onclick="openIpModal('{{ $ip }}', '{{ $node.Name }}', {{ $node.Verified }})"
                                    >
                                        {{ $ip }}
                                    </span>
                                </td>
                                <td class="name-cell">
                                    {{if $node.Name}}{{ $node.Name
                                    }}{{else}}<span style="color: #666">—</span
                                    >{{end}}
                                </td>
                                <td class="last-seen-cell">
                                    <span
                                        class="human-time"
                                        data-time="{{ $node.LastOnlineAt }}"
                                    ></span>
                                </td>
                                <td class="latency-cell">
                                    {{ $node.LastPingDuration }}
                                </td>
                                <td class="ports-column">
                                    {{ $hasUnverified := false }} {{ range $port
                                    := $node.Ports }} {{ if not $port.Verified
                                    }} {{ $hasUnverified = true }} {{ end }} {{
                                    end }}

                                    <div class="port-container">
                                        {{range $port := $node.Ports }}
                                        <div
                                            title="{{if $port.Notes}}{{$port.Notes}}{{else}}Port {{$port.PortNumber}}{{end}}"
                                            class="port-box {{ if not $port.Verified }}port-box-warning{{end}}"
                                            onclick="openPortModal({ ip: '{{ $ip }}', portNumber: {{ $port.PortNumber }}, notes: '{{ $port.Notes }}', verified: {{ $port.Verified }}, lastSeenAt: '{{ $port.LastSeenAt }}'})"
                                        >
                                            <div class="port-number">
                                                {{ $port.PortNumber }}
                                            </div>
                                            {{if $port.Notes}}
                                            <div class="port-label">
                                                <span class="port-has-notes"
                                                    >★</span
                                                >
                                            </div>
                                            {{end}}
                                        </div>
                                        {{end}}
                                    </div>

                                    {{ if $hasUnverified }}
                                    <div class="verify-all-container">
                                        <button
                                            onclick="verifyAllPorts('{{ $ip }}')"
                                        >
                                            Verify All Ports
                                        </button>
                                    </div>
                                    {{ end }}
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modal box for showing port details -->
        <div id="portModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closePortModal()">&times;</span>
                <h2 id="modal-title"></h2>
                <form id="port-form">
                    <input type="hidden" id="port-ip" name="port-ip" />
                    <input
                        type="hidden"
                        id="port-port-number"
                        name="port-port-number"
                    />

                    <div class="modal-checkbox-container">
                        <label for="port-verified">Verified:</label>
                        <input
                            type="checkbox"
                            id="port-verified"
                            name="port-verified"
                        />
                    </div>

                    <div class="modal-port-notes-container">
                        <label for="port-notes">Notes:</label>
                        <textarea
                            id="port-notes"
                            name="port-notes"
                            rows="4"
                            cols="50"
                        ></textarea>
                    </div>

                    <div class="modal-port-notes-container">
                        <label for="port-last-seen">Last Seen:</label>
                        <div id="port-last-seen" style="padding: 12px; background-color: #1e1e1e; border-radius: 6px; color: #a0a0a0;"></div>
                    </div>

                    <button type="submit">Save</button>
                </form>
            </div>
        </div>

        <!-- Modal box for configuring IP names -->
        <div id="ipModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeIpModal()">&times;</span>
                <h2 id="ip-modal-title"></h2>
                <form id="ip-form">
                    <input type="hidden" id="ip-address" name="ip-address" />

                    <div class="modal-checkbox-container">
                        <label for="ip-verified">Verified:</label>
                        <input
                            type="checkbox"
                            id="ip-verified"
                            name="ip-verified"
                        />
                    </div>

                    <div class="modal-ip-name-container">
                        <label for="ip-name">Name:</label>
                        <input
                            type="text"
                            id="ip-name"
                            name="ip-name"
                            placeholder="Enter a friendly name for this device"
                        />
                    </div>

                    <button type="submit">Save</button>
                </form>
            </div>
        </div>

        <script>
            let g_changesReceived = false;
            let g_updateTimeout = null;

            function wsUrl() {
                const protocol =
                    window.location.protocol === "https:" ? "wss" : "ws";
                const hostname = window.location.hostname;

                let port = window.location.port;

                if (!port) {
                    port = protocol === "wss" ? 443 : 80;
                }
                const wsUrl = `${protocol}://${hostname}:${port}/ws`;

                return wsUrl;
            }

            function openPortModal(info) {
                document.getElementById("modal-title").textContent =
                    `${info.ip}:${info.portNumber} details`;
                document.getElementById("port-verified").checked =
                    info.verified;
                document.getElementById("port-notes").value = info.notes;
                document.getElementById("port-ip").value = info.ip;
                document.getElementById("port-port-number").value =
                    info.portNumber;

                const lastSeenEl = document.getElementById("port-last-seen");
                if (info.lastSeenAt && info.lastSeenAt !== '') {
                    lastSeenEl.textContent = timeAgo(info.lastSeenAt);
                } else {
                    lastSeenEl.textContent = 'Never';
                }

                document.getElementById("portModal").style.display = "block";
            }

            function closePortModal() {
                const modal = document.getElementById("portModal");
                modal.style.display = "none";

                if (g_changesReceived) {
                    if (g_updateTimeout) {
                        clearTimeout(g_updateTimeout);
                    }

                    location.reload();
                }
            }

            function openIpModal(ip, currentName, verified) {
                document.getElementById("ip-modal-title").textContent =
                    `Configure ${ip}`;
                document.getElementById("ip-address").value = ip;
                document.getElementById("ip-name").value = currentName || "";
                document.getElementById("ip-verified").checked = verified;
                document.getElementById("ipModal").style.display = "block";
            }

            function closeIpModal() {
                const modal = document.getElementById("ipModal");
                modal.style.display = "none";

                if (g_changesReceived) {
                    if (g_updateTimeout) {
                        clearTimeout(g_updateTimeout);
                    }

                    location.reload();
                }
            }

            // Keyboard shortcuts for modals
            document.addEventListener("keydown", function (e) {
                if (e.key === "Escape") {
                    const portModal = document.getElementById("portModal");
                    const ipModal = document.getElementById("ipModal");

                    if (portModal.style.display === "block") {
                        closePortModal();
                    } else if (ipModal.style.display === "block") {
                        closeIpModal();
                    }
                }
            });

            // Close modal when clicking outside of it
            window.onclick = function (event) {
                const portModal = document.getElementById("portModal");
                const ipModal = document.getElementById("ipModal");

                if (event.target === portModal) {
                    closePortModal();
                } else if (event.target === ipModal) {
                    closeIpModal();
                }
            };

            function modalOpened() {
                return (
                    document.getElementById("portModal").style.display ===
                        "block" ||
                    document.getElementById("ipModal").style.display === "block"
                );
            }

            async function verifyPort(ip, portNumber, verified, notes) {
                return fetch("/ports/verify", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        ip: ip,
                        port: portNumber,
                        verified: verified,
                        notes: notes,
                    }),
                })
                    .then((response) => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error("Network response was not ok");
                        }
                    })
                    .then((data) => {
                        location.reload();
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                    })
                    .finally(() => {
                        closePortModal();
                    });
            }

            // Handle port form submission
            document.getElementById("port-form").onsubmit = async function (e) {
                e.preventDefault();
                const verified =
                    document.getElementById("port-verified").checked;
                const notes = document.getElementById("port-notes").value;
                const ip = document.getElementById("port-ip").value;
                const portNumber = parseInt(
                    document.getElementById("port-port-number").value,
                );

                return verifyPort(ip, portNumber, verified, notes);
            };

            // Handle IP name form submission
            document.getElementById("ip-form").onsubmit = function (e) {
                e.preventDefault();
                const ip = document.getElementById("ip-address").value;
                const name = document.getElementById("ip-name").value;
                const verified = document.getElementById("ip-verified").checked;

                fetch("/ips/verify", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        ip,
                        name,
                        verified,
                    }),
                })
                    .then((response) => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error("Network response was not ok");
                        }
                    })
                    .then((data) => {
                        location.reload();
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                    })
                    .finally(() => {
                        closeIpModal();
                    });
            };

            const socket = new WebSocket(wsUrl());

            socket.onopen = function () {
                console.log("web sock connection opened");
            };

            socket.onmessage = function (e) {
                g_changesReceived = true;

                if (modalOpened()) {
                    return;
                } else {
                    if (!g_updateTimeout) {
                        g_updateTimeout = setTimeout(
                            refreshDashboard,
                            10 * 1000,
                        );
                    }
                }
            };

            async function verifyAllPorts(ip) {
                return fetch("/ports/verify-all", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        ip: ip,
                        verified: true,
                    }),
                })
                    .then((response) => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error("Network response was not ok");
                        }
                    })
                    .then((data) => {
                        location.reload();
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                    });
            }

            function refreshDashboard() {
                if (!modalOpened()) {
                    g_changesReceived = false;
                    uptimeTimeout = null;

                    location.reload();
                }
            }

            function send() {
                socket.send(input.value);
                input.value = "";
            }

            function timeAgo(dateString) {
                // Parse string into a Date object
                const date = new Date(dateString);
                const now = new Date();

                const seconds = Math.floor((now - date) / 1000);

                const intervals = [
                    { label: "year", seconds: 31536000 },
                    { label: "month", seconds: 2592000 },
                    { label: "day", seconds: 86400 },
                    { label: "hour", seconds: 3600 },
                    { label: "minute", seconds: 60 },
                    { label: "second", seconds: 1 },
                ];

                for (const interval of intervals) {
                    const count = Math.floor(seconds / interval.seconds);
                    if (count > 0) {
                        return count === 1
                            ? `${count} ${interval.label} ago`
                            : `${count} ${interval.label}s ago`;
                    }
                }

                return "just now";
            }

            // On load

            document.querySelectorAll(".human-time").forEach((el) => {
                const raw = el.getAttribute("data-time");
                el.textContent = timeAgo(raw);
            });
        </script>
    </body>
</html>
